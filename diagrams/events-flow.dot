digraph EventsFlow {
    rankdir=TB;
    
    graph [
        fontname="Arial, sans-serif"
        fontsize=12
        bgcolor="#fafafa"
        style=filled
        pad=0.5
        nodesep=0.8
        ranksep=1.2
    ];
    
    node [
        fontname="Arial, sans-serif"
        fontsize=10
        style=filled
        shape=box
        margin=0.1
    ];
    
    edge [
        fontname="Arial, sans-serif"
        fontsize=9
        color="#666666"
    ];

    // Domain Events
    subgraph cluster_events {
        label="ğŸ“¡ DOMAIN EVENTS";
        style=filled;
        fillcolor="#fff3e0";
        color="#f57c00";
        fontcolor="#f57c00";
        fontsize=14;
        
        ProductCreated [
            label="ğŸ‰ ProductCreated\nâ€¢ productId\nâ€¢ productName\nâ€¢ price\nâ€¢ timestamp"
            fillcolor="#ffb74d"
            shape=ellipse
        ];
        
        ProductUpdated [
            label="ğŸ“ ProductUpdated\nâ€¢ productId\nâ€¢ changes\nâ€¢ timestamp"
            fillcolor="#ffb74d"
            shape=ellipse
        ];
        
        StockChanged [
            label="ğŸ“¦ StockChanged\nâ€¢ productId\nâ€¢ oldStock\nâ€¢ newStock\nâ€¢ changeType\nâ€¢ timestamp"
            fillcolor="#ffb74d"
            shape=ellipse
        ];
        
        UserCreated [
            label="ğŸ‘¤ UserCreated\nâ€¢ userId\nâ€¢ userName\nâ€¢ email\nâ€¢ timestamp"
            fillcolor="#ffb74d"
            shape=ellipse
        ];
        
        UserActivated [
            label="âœ… UserActivated\nâ€¢ userId\nâ€¢ timestamp"
            fillcolor="#ffb74d"
            shape=ellipse
        ];
    }

    // Event Bus
    EventBus [
        label="ğŸšŒ EventBus\n(InMemoryEventBus)\n\nâ€¢ publish(event)\nâ€¢ subscribe(eventName, handler)\nâ€¢ handlers: Map<string, Handler[]>\nâ€¢ async processing"
        fillcolor="#ff9800"
        color="#f57c00"
        fontsize=11
        shape=doubleoctagon
    ];

    // Event Handlers
    subgraph cluster_handlers {
        label="ğŸ“¬ EVENT HANDLERS\n(Asynchronous Processing)";
        style=filled;
        fillcolor="#e8f5e8";
        color="#388e3c";
        fontcolor="#388e3c";
        fontsize=14;
        
        NotificationHandler [
            label="ğŸ“§ NotificationHandler\nâ€¢ Send email notifications\nâ€¢ Push notifications\nâ€¢ SMS alerts\nâ€¢ Webhook calls"
            fillcolor="#a5d6a7"
        ];
        
        AuditHandler [
            label="ğŸ“‹ AuditHandler\nâ€¢ Log all domain events\nâ€¢ Create audit trail\nâ€¢ Compliance tracking\nâ€¢ History records"
            fillcolor="#a5d6a7"
        ];
        
        AnalyticsHandler [
            label="ğŸ“Š AnalyticsHandler\nâ€¢ Update statistics\nâ€¢ Generate reports\nâ€¢ Track KPIs\nâ€¢ Business metrics"
            fillcolor="#a5d6a7"
        ];
        
        CacheHandler [
            label="ğŸ’¾ CacheHandler\nâ€¢ Invalidate cached data\nâ€¢ Update cache entries\nâ€¢ Refresh search indices\nâ€¢ Clear related cache"
            fillcolor="#a5d6a7"
        ];
        
        IntegrationHandler [
            label="ğŸ”— IntegrationHandler\nâ€¢ Sync with external systems\nâ€¢ ERP integration\nâ€¢ Third-party APIs\nâ€¢ Data synchronization"
            fillcolor="#a5d6a7"
        ];
    }

    // Use Cases (Event Publishers)
    subgraph cluster_publishers {
        label="ğŸ¢ EVENT PUBLISHERS\n(Use Cases)";
        style=filled;
        fillcolor="#e3f2fd";
        color="#1976d2";
        fontcolor="#1976d2";
        fontsize=14;
        
        CreateProductUseCase [
            label="âš™ï¸ CreateProduct\nUse Case\npublish(ProductCreated)"
            fillcolor="#90caf9"
        ];
        
        UpdateProductUseCase [
            label="âš™ï¸ UpdateProduct\nUse Case\npublish(ProductUpdated)"
            fillcolor="#90caf9"
        ];
        
        IncreaseStockUseCase [
            label="âš™ï¸ IncreaseStock\nUse Case\npublish(StockChanged)"
            fillcolor="#90caf9"
        ];
        
        CreateUserUseCase [
            label="âš™ï¸ CreateUser\nUse Case\npublish(UserCreated)"
            fillcolor="#90caf9"
        ];
    }

    // External Systems
    subgraph cluster_external {
        label="ğŸŒ EXTERNAL SYSTEMS";
        style=filled;
        fillcolor="#f3e5f5";
        color="#7b1fa2";
        fontcolor="#7b1fa2";
        fontsize=14;
        
        EmailService [
            label="ğŸ“¬ Email Service\n(SendGrid/AWS SES)"
            fillcolor="#ce93d8"
            shape=cylinder
        ];
        
        AuditDatabase [
            label="ğŸ“Š Audit Database\n(Event Store)"
            fillcolor="#ce93d8"
            shape=cylinder
        ];
        
        Analytics [
            label="ğŸ“ˆ Analytics Platform\n(Google Analytics/Mixpanel)"
            fillcolor="#ce93d8"
            shape=cylinder
        ];
        
        Cache [
            label="ğŸ’¾ Cache System\n(Redis/Memcached)"
            fillcolor="#ce93d8"
            shape=cylinder
        ];
        
        ERPSystem [
            label="ğŸ­ ERP System\n(SAP/Oracle)"
            fillcolor="#ce93d8"
            shape=cylinder
        ];
    }

    // Flow: Use Cases -> Events
    CreateProductUseCase -> ProductCreated [label="emits" color="#2196f3"];
    UpdateProductUseCase -> ProductUpdated [label="emits" color="#2196f3"];
    IncreaseStockUseCase -> StockChanged [label="emits" color="#2196f3"];
    CreateUserUseCase -> UserCreated [label="emits" color="#2196f3"];

    // Flow: Events -> EventBus
    ProductCreated -> EventBus [label="publish" color="#ff9800"];
    ProductUpdated -> EventBus [label="publish" color="#ff9800"];
    StockChanged -> EventBus [label="publish" color="#ff9800"];
    UserCreated -> EventBus [label="publish" color="#ff9800"];
    UserActivated -> EventBus [label="publish" color="#ff9800"];

    // Flow: EventBus -> Handlers
    EventBus -> NotificationHandler [label="async notify" color="#4caf50" style=dashed];
    EventBus -> AuditHandler [label="async log" color="#4caf50" style=dashed];
    EventBus -> AnalyticsHandler [label="async track" color="#4caf50" style=dashed];
    EventBus -> CacheHandler [label="async invalidate" color="#4caf50" style=dashed];
    EventBus -> IntegrationHandler [label="async sync" color="#4caf50" style=dashed];

    // Flow: Handlers -> External Systems
    NotificationHandler -> EmailService [label="send emails" color="#9c27b0"];
    AuditHandler -> AuditDatabase [label="store events" color="#9c27b0"];
    AnalyticsHandler -> Analytics [label="track metrics" color="#9c27b0"];
    CacheHandler -> Cache [label="update cache" color="#9c27b0"];
    IntegrationHandler -> ERPSystem [label="sync data" color="#9c27b0"];

    // Event Subscriptions (registration)
    subgraph cluster_subscriptions {
        label="ğŸ”” EVENT SUBSCRIPTIONS\n(Handler Registration)";
        style=filled;
        fillcolor="#fff8e1";
        color="#ffa000";
        fontcolor="#ffa000";
        fontsize=12;
        
        Subscriptions [
            label="ğŸ“‹ Event Subscriptions\n\nproduct.created:\n  â†’ NotificationHandler\n  â†’ AuditHandler\n  â†’ AnalyticsHandler\n\nproduct.updated:\n  â†’ AuditHandler\n  â†’ CacheHandler\n\nstock.changed:\n  â†’ NotificationHandler\n  â†’ AnalyticsHandler\n  â†’ IntegrationHandler\n\nuser.created:\n  â†’ NotificationHandler\n  â†’ AuditHandler"
            fillcolor="#ffecb3"
            shape=note
        ];
    }

    // Event Flow Patterns
    subgraph cluster_patterns {
        label="ğŸ”„ EVENT PATTERNS";
        style=filled;
        fillcolor="#e8eaf6";
        color="#3f51b5";
        fontcolor="#3f51b5";
        fontsize=12;
        
        Patterns [
            label="ğŸ“ Common Patterns\n\nğŸ”„ Publish-Subscribe\nâ€¢ Loose coupling\nâ€¢ Async processing\n\nâš¡ Event Sourcing\nâ€¢ Complete event history\nâ€¢ Audit trail\n\nğŸ¯ CQRS Ready\nâ€¢ Command/Query separation\nâ€¢ Event-driven updates\n\nğŸ”— Saga Pattern\nâ€¢ Distributed transactions\nâ€¢ Compensation actions"
            fillcolor="#c5cae9"
            shape=note
        ];
    }

    // Benefits box
    Benefits [
        label="âœ¨ BENEFITS\n\nğŸ”’ Decoupling\nâ€¢ Independent handlers\nâ€¢ No direct dependencies\n\nâš¡ Scalability\nâ€¢ Async processing\nâ€¢ Horizontal scaling\n\nğŸ”„ Extensibility\nâ€¢ Easy to add handlers\nâ€¢ Plugin architecture\n\nğŸ“Š Observability\nâ€¢ Event tracking\nâ€¢ System monitoring"
        fillcolor="#e8f5e8"
        color="#4caf50"
        shape=note
    ];

    // TÃ­tulo
    labelloc="t";
    label=<<B>Domain Events &amp; Asynchronous Communication</B><BR/>
    <I>Event-Driven Architecture with EventBus Pattern</I><BR/>
    <FONT POINT-SIZE="10">Loose coupling through domain events and async processing</FONT>>;
    fontsize=16;
}
